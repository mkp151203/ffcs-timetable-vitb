{% extends "base.html" %}

{% block title %}VIT Bhopal FFCS Timetable Maker{% endblock %}

{% block content %}
<!-- Header -->
<header class="app-header">
    <div class="header-container">
        <div class="header-logo">
            <h1><i class="fas fa-calendar-alt"></i> VIT Bhopal FFCS Timetable Maker</h1>
        </div>

        {% if not current_user %}
        <div class="guest-alert">
            <i class="fas fa-info-circle"></i>
            <span>Guest Mode: Data is temporary</span>
        </div>
        {% endif %}

        <div class="header-auth">
            {% if current_user %}
            <div class="user-profile">
                {% if current_user.profile_pic %}
                <img src="{{ current_user.profile_pic }}" alt="Avatar" class="user-avatar">
                {% endif %}
                <span class="user-name">{{ current_user.name }}</span>
                <a href="{{ url_for('auth.logout') }}" class="btn-logout" title="Logout">
                    <i class="fas fa-sign-out-alt"></i>
                </a>
            </div>
            {% else %}
            <a href="{{ url_for('auth.login') }}" class="btn-google-login">
                <svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="18px" height="18px" viewBox="0 0 48 48"
                    class="abcRioButtonSvg">
                    <g>
                        <path fill="#EA4335"
                            d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z">
                        </path>
                        <path fill="#4285F4"
                            d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z">
                        </path>
                        <path fill="#FBBC05"
                            d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z">
                        </path>
                        <path fill="#34A853"
                            d="M24 48c6.48 0 11.95-2.09 15.81-5.65l-7.73-6c-2.15 1.45-4.92 2.3-8.08 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z">
                        </path>
                        <path fill="none" d="M0 0h48v48H0z"></path>
                    </g>
                </svg> Login with VIT Email
            </a>
            {% endif %}
        </div>
    </div>


</header>

<!-- Main Content -->
<main class="app-main">
    <!-- Left Sidebar - Course Search -->
    <aside class="sidebar sidebar-left">
        <div class="search-panel">
            <h3><i class="fas fa-search"></i> Search Courses</h3>
            <div class="search-input-wrapper">
                <input type="text" id="courseSearch" placeholder="Enter Course Code (e.g., MAT2001)" autocomplete="off">
                <button type="button" id="searchBtn" class="btn btn-primary">
                    <i class="fas fa-search"></i> Find
                </button>
            </div>
            <div id="searchResults" class="search-results"></div>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
            <h3><i class="fas fa-bolt"></i> Quick Actions</h3>
            <ul class="action-list">
                <li>
                    <button onclick="openModifyCoursesModal()" class="action-btn">
                        <i class="fas fa-edit"></i> Modify Courses
                    </button>
                </li>
                <li>
                    <button onclick="viewAllCourses()" class="action-btn">
                        <i class="fas fa-list"></i> View All Courses
                    </button>
                </li>
                <li>
                    <button onclick="clearAllRegistrations()" class="action-btn action-danger">
                        <i class="fas fa-trash"></i> Clear All
                    </button>
                </li>
            </ul>
        </div>

        <!-- HTML Upload moved to top card -->

        <!-- Manual Entry moved to top card -->
    </aside>

    <!-- Center - Content Column -->
    <div class="main-content-column">
        <!-- Import Data Card -->
        <div class="import-data-card">
            <div class="import-card-header">
                <h3><i class="fas fa-file-import"></i> Import Data</h3>
                <p>Add courses from various sources</p>
            </div>
            <div class="import-actions-grid">
                <button class="import-action-btn" onclick="openHtmlImportModal()">
                    <div class="icon-box html-icon"><i class="fas fa-code"></i></div>
                    <div class="btn-text">
                        <span class="btn-title">Import HTML</span>
                        <span class="btn-desc">From VTOP Page Source</span>
                    </div>
                </button>
                <button class="import-action-btn" onclick="openCsvUploadModal()">
                    <div class="icon-box csv-icon"><i class="fas fa-file-csv"></i></div>
                    <div class="btn-text">
                        <span class="btn-title">Import CSV</span>
                        <span class="btn-desc">From Spreadsheet</span>
                    </div>
                </button>
                <button class="import-action-btn" onclick="openOcrImportModal()">
                    <div class="icon-box ai-icon"><i class="fas fa-robot"></i></div>
                    <div class="btn-text">
                        <span class="btn-title">AI Import</span>
                        <span class="btn-desc">From Screenshot</span>
                    </div>
                </button>
                <button class="import-action-btn" onclick="openManualImportModal()">
                    <div class="icon-box manual-icon"><i class="fas fa-keyboard"></i></div>
                    <div class="btn-text">
                        <span class="btn-title">Manual Entry</span>
                        <span class="btn-desc">Type Data Directly</span>
                    </div>
                </button>
            </div>
        </div>

        <!-- Timetable Section -->
        <section class="timetable-section">
            <div class="timetable-header">
                <h2>Your Timetable</h2>
                <div class="header-actions">
                    <a href="{{ url_for('generate.generate_page', tab='saved') }}" class="btn btn-info header-btn">
                        <i class="fas fa-bookmark"></i> View Saved
                    </a>
                    <button class="btn btn-warning header-btn" onclick="saveCurrentTimetable()">
                        <i class="fas fa-save"></i> Save Timetable
                    </button>
                    <a href="{{ url_for('generate.generate_page') }}" class="btn btn-success header-btn">
                        <i class="fas fa-magic"></i> Auto Generate
                    </a>
                    <button class="btn btn-primary header-btn" onclick="downloadTimetablePDF()" title="Download as PDF">
                        <i class="fas fa-file-pdf"></i> Download
                    </button>
                </div>
                <div id="cellSelectionBar" class="cell-selection-bar" style="display: none;">
                    <span id="selectedCellsCount">0 slots selected</span>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="clearCellSelection()">
                        <i class="fas fa-times"></i> Clear
                    </button>
                    <button type="button" class="btn btn-sm btn-success" onclick="openManualEntryModal()">
                        <i class="fas fa-plus"></i> Add Course
                    </button>
                </div>
            </div>

            {% include "components/timetable_grid.html" %}

            <!-- Registered Courses List (moved below timetable) -->
            <div class="registered-panel-inline">
                <h3><i class="fas fa-list-check"></i> Registered Courses</h3>
                <div id="registeredCoursesList" class="registered-list-inline">
                    {% if course_count == 0 %}
                    <p class="empty-message">No courses registered yet.</p>
                    {% endif %}
                </div>
            </div>
        </section>
    </div>
</main>

<!-- Faculty Selection Modal -->
{% include "components/faculty_modal.html" %}

<!-- Registered Courses Modal -->
<div id="registeredModal" class="modal">
    <div class="modal-content modal-lg">
        <div class="modal-header">
            <h2><i class="fas fa-book"></i> Registered Courses</h2>
            <button class="modal-close" onclick="closeRegisteredModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div id="registeredModalContent"></div>
        </div>
    </div>
</div>

<!-- All Courses Modal -->
<div id="allCoursesModal" class="modal">
    <div class="modal-content modal-xl">
        <div class="modal-header">
            <h2><i class="fas fa-list"></i> All Courses</h2>
            <button class="modal-close" onclick="closeAllCoursesModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div id="allCoursesModalContent"></div>
        </div>
    </div>
</div>

<!-- Saved Timetables Modal -->
<div id="savedTimetablesModal" class="modal">
    <div class="modal-content modal-lg">
        <div class="modal-header">
            <h2><i class="fas fa-bookmark"></i> Saved Timetables</h2>
            <button class="modal-close" onclick="closeSavedTimetablesModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div id="savedTimetablesModalContent" class="saved-grid">
                <!-- Cards will be injected here -->
            </div>
        </div>
    </div>
</div>

<!-- Import Help Modal -->
<div id="importHelpModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-info-circle"></i> How to Download HTML Files</h2>
            <button class="modal-close" onclick="closeImportHelp()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="help-steps">
                <div class="help-step">
                    <span class="step-number">1</span>
                    <div class="step-content">
                        <strong>Login to VIT VTOP</strong>
                        <p>Log in to VIT mock registration portal</p>
                    </div>
                </div>
                <div class="help-step">
                    <span class="step-number">2</span>
                    <div class="step-content">
                        <strong>Select Course Category</strong>
                        <p>Select the course category you want to register for</p>
                    </div>
                </div>
                <div class="help-step">
                    <span class="step-number">3</span>
                    <div class="step-content">
                        <strong>Select Course</strong>
                        <p>Select the course you want to register for</p>
                    </div>
                </div>
                <div class="help-step">
                    <span class="step-number">4</span>
                    <div class="step-content">
                        <strong>Open faculty list</strong>
                        <p>open faculty list to view its slot options</p>
                    </div>
                </div>
                <div class="help-step">
                    <span class="step-number">5</span>
                    <div class="step-content">
                        <strong>Save Page as HTML</strong>
                        <p>Press <kbd>Ctrl</kbd>+<kbd>S</kbd> and save as "Webpage, HTML Only"</p>
                    </div>
                </div>
                <div class="help-step">
                    <span class="step-number">6</span>
                    <div class="step-content">
                        <strong>Upload Here</strong>
                        <p>Select the saved HTML file(s) and click Import</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Manual Entry Modal -->
<div id="manualEntryModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-plus-circle"></i> Add Course Manually</h2>
            <button class="modal-close" onclick="closeManualEntryModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="manualEntryForm" onsubmit="submitManualEntry(event)">
                <div class="form-group">
                    <label for="manualCourseCode">Course Code *</label>
                    <input type="text" id="manualCourseCode" required placeholder="e.g., CSE3006" class="form-control">
                </div>
                <div class="form-group">
                    <label for="manualCourseName">Course Name *</label>
                    <input type="text" id="manualCourseName" required placeholder="e.g., Computer Networks"
                        class="form-control">
                </div>
                <div class="form-group">
                    <label for="manualCredits">Credits</label>
                    <input type="number" id="manualCredits" min="0" max="20" placeholder="e.g., 4 (optional)"
                        class="form-control">
                </div>
                <div class="form-group">
                    <label for="manualSlotCode">Slot Code *</label>
                    <input type="text" id="manualSlotCode" required placeholder="e.g., A11+A12+A13"
                        class="form-control">
                </div>
                <div class="form-group">
                    <label for="manualVenue">Venue</label>
                    <input type="text" id="manualVenue" placeholder="e.g., AB505 (optional)" class="form-control">
                </div>
                <div class="form-group">
                    <label for="manualFaculty">Faculty Name</label>
                    <input type="text" id="manualFaculty" placeholder="e.g., John Doe (optional)" class="form-control">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeManualEntryModal()">Cancel</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-check"></i> Add Course
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- HTML Import Modal -->
<div id="htmlImportModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-code"></i> Import HTML Files</h2>
            <button class="modal-close" onclick="closeHtmlImportModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="steps-guide">
                <strong>How to Import:</strong>
                <ol>
                    <li>Go to VTOP Mock FFCS page </li>
                    <li>Select course type -> Select course ->Open faculty list</li>
                    <li>Press: <strong>Ctrl + S</strong></li>
                    <li>Save the file as <strong>Webpage, HTML Only</strong></li>
                    <li>Click below to upload the saved .html file</li>
                </ol>
            </div>
            <p class="upload-hint">Upload HTML files saved from the VTOP Course Page.</p>

            <div class="upload-area">
                <input type="file" id="htmlFileInput" accept=".html,.htm,.mhtml,.csv" multiple style="display: none;">
                <button type="button" id="uploadBtn" class="btn btn-secondary"
                    onclick="document.getElementById('htmlFileInput').click()">
                    <i class="fas fa-file-upload"></i> Select Files
                </button>
                <span id="selectedFileName" class="file-name"></span>
            </div>

            <div id="uploadStatus" class="upload-status"></div>

            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeHtmlImportModal()">Cancel</button>
                <button type="button" id="importBtn" class="btn btn-success" onclick="importHtmlFiles()" disabled>
                    <i class="fas fa-download"></i> Import All
                </button>
            </div>
        </div>
    </div>
</div>

<!-- CSV Upload Modal -->
<div id="csvUploadModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-file-csv"></i> Import Course from CSV</h2>
            <button class="modal-close" onclick="closeCsvUploadModal()">&times;</button>
        </div>
        <div class="modal-body">
            <p class="upload-hint">Upload a CSV file containing course and faculty/slot data.</p>
            <a href="{{ url_for('upload.download_csv_template') }}" class="template-download-link" download>
                <i class="fas fa-download"></i> Download CSV Template
            </a>

            <div class="csv-format-info">
                <strong>CSV Format:</strong>
                <pre>course_code,course_name,l,t,p,j,c,course_type,category
CSA3006,DATA MINING,2,1,1,0,4,LTP,PC
slot_code,faculty,venue,available_seats
A11+A12+A13,FACULTY NAME,AB02-330,0</pre>
            </div>

            <div class="upload-area">
                <input type="file" id="csvFileInput" accept=".csv" style="display: none;">
                <button type="button" class="btn btn-secondary"
                    onclick="document.getElementById('csvFileInput').click()">
                    <i class="fas fa-file-upload"></i> Select CSV File
                </button>
                <span id="csvFileName" class="file-name"></span>
            </div>

            <div id="csvUploadStatus" class="upload-status"></div>

            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeCsvUploadModal()">Cancel</button>
                <button type="button" id="csvImportBtn" class="btn btn-success" onclick="importCsvFile()" disabled>
                    <i class="fas fa-upload"></i> Import Course
                </button>
            </div>
        </div>
    </div>
</div>

<!-- AI Import Modal -->
<div id="ocrImportModal" class="modal">
    <div class="modal-content modal-xl">
        <div class="modal-header">
            <h2><i class="fas fa-robot"></i> AI-Assisted Course Import</h2>
            <button class="modal-close" onclick="closeOcrImportModal()">&times;</button>
        </div>
        <div class="modal-body">
            <!-- Step Indicator -->
            <div class="ocr-steps">
                <div class="ocr-step active" data-step="1">
                    <span class="step-num">1</span>
                    <span class="step-label">Course Details</span>
                </div>
                <div class="ocr-step" data-step="2">
                    <span class="step-num">2</span>
                    <span class="step-label" id="ocrStep2Label">AI Extract</span>
                </div>
                <div class="ocr-step" data-step="3">
                    <span class="step-num">3</span>
                    <span class="step-label">Review & Import</span>
                </div>
            </div>

            <!-- Step 1: Course Details -->
            <div id="ocrStep1" class="ocr-step-content active">
                <h3>Enter Course Details</h3>
                <div class="ocr-form-grid">
                    <div class="form-group">
                        <label>Course Code *</label>
                        <input type="text" id="ocrCourseCode" required placeholder="e.g., CSA4029" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Course Name *</label>
                        <input type="text" id="ocrCourseName" required placeholder="e.g., REINFORCEMENT LEARNING"
                            class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Course Type</label>
                        <select id="ocrCourseType" class="form-control">
                            <option value="LTP">LTP (Theory + Lab)</option>
                            <option value="Theory">Theory Only</option>
                            <option value="Lab">Lab Only</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <select id="ocrCategory" class="form-control">
                            <option value="PC">PC (Program Core)</option>
                            <option value="PE">PE (Program Elective)</option>
                            <option value="UC">UC (University Core)</option>
                            <option value="UE">UE (University Elective)</option>
                        </select>
                    </div>
                </div>
                <div class="ocr-form-grid credits-grid">
                    <div class="form-group">
                        <label>L (Lecture)</label>
                        <input type="number" id="ocrL" value="2" min="0" max="10" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>T (Tutorial)</label>
                        <input type="number" id="ocrT" value="1" min="0" max="10" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>P (Practical)</label>
                        <input type="number" id="ocrP" value="1" min="0" max="10" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>J (Project)</label>
                        <input type="number" id="ocrJ" value="0" min="0" max="10" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>C (Credits)</label>
                        <input type="number" id="ocrC" value="4" min="0" max="20" class="form-control">
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeOcrImportModal()">Cancel</button>
                    <button type="button" class="btn btn-primary" id="ocrStep1NextBtn" onclick="ocrNextStep(2)">
                        Next: Upload Images <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>

            <!-- Step 2: Extract with AI -->
            <div id="ocrStep2" class="ocr-step-content">
                <h3><i class="fas fa-robot"></i> Extract Faculty Data with AI</h3>

                <div class="ai-extract-steps">
                    <div class="ai-step">
                        <span class="ai-step-num">1</span>
                        <div class="ai-step-content">
                            <strong>Take a screenshot</strong> of the faculty list table from VTOP
                        </div>
                    </div>
                    <div class="ai-step">
                        <span class="ai-step-num">2</span>
                        <div class="ai-step-content">
                            <strong>Open any AI chatbot</strong> (ChatGPT, Gemini, Claude, etc.)
                        </div>
                    </div>
                    <div class="ai-step">
                        <span class="ai-step-num">3</span>
                        <div class="ai-step-content">
                            <strong>Upload the image</strong> and paste this prompt:
                        </div>
                    </div>
                </div>

                <div class="ai-prompt-box">
                    <div class="prompt-header">
                        <span><i class="fas fa-clipboard"></i> Copy this prompt:</span>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="copyAiPrompt()">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                    </div>
                    <pre id="aiPromptText">Extract the faculty table data from this image. Output ONLY in this exact CSV format with no extra text:

slot_code,venue,faculty,available_seats
A11+A12+A13,AB02-423,ANIL KUMAR YADAV,95
(continue for all rows)

Rules:
- slot_code: The slot combination (e.g., A11+A12+A13)
- venue: The room/venue code (e.g., AB02-423)
- faculty: Faculty name only (no titles)
- available_seats: The number in "Available" column (just the number)
- Skip any header rows
- Output ONLY the CSV data, no explanations</pre>
                </div>

                <div class="ai-step" style="margin-top: 16px;">
                    <span class="ai-step-num">4</span>
                    <div class="ai-step-content">
                        <strong>Paste the AI output below:</strong>
                    </div>
                </div>

                <textarea id="aiOutputText" class="form-control ai-output-textarea" rows="8" placeholder="Paste the AI response here...

Example:
slot_code,venue,faculty,available_seats
A11+A12+A13,AB02-423,ANIL KUMAR YADAV,95
A11+A12+A13,AB02-402,NILESH KUNHARE,101
A14+D11+D12,AB02-428,ABDUL,61"></textarea>

                <div id="aiParseStatus" class="upload-status"></div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="ocrPrevStep(1)">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                    <button type="button" id="ocrProcessBtn" class="btn btn-primary" onclick="parseAiOutput()">
                        <i class="fas fa-magic"></i> Parse Data
                    </button>
                </div>
            </div>

            <!-- Step 3: Review & Import -->
            <div id="ocrStep3" class="ocr-step-content">
                <h3>Review Extracted Data</h3>
                <p class="upload-hint">Review and fix any errors in the extracted data. You can edit cells by clicking
                    on them.</p>

                <div class="ocr-review-actions">
                    <button type="button" class="btn btn-sm btn-secondary" onclick="ocrAddRow()">
                        <i class="fas fa-plus"></i> Add Row
                    </button>
                    <button type="button" class="btn btn-sm btn-danger" onclick="ocrDeleteSelectedRows()">
                        <i class="fas fa-trash"></i> Delete Selected
                    </button>
                </div>

                <div class="ocr-table-container">
                    <table class="ocr-review-table" id="ocrReviewTable">
                        <thead>
                            <tr>
                                <th style="width: 40px;"><input type="checkbox" id="ocrSelectAll"
                                        onclick="ocrToggleSelectAll()"></th>
                                <th>Slot Code</th>
                                <th>Venue</th>
                                <th>Faculty Name</th>
                                <th>Available Seats</th>
                                <th style="width: 50px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ocrReviewBody">
                            <!-- Rows will be added dynamically -->
                        </tbody>
                    </table>
                </div>

                <div id="ocrReviewStatus" class="upload-status"></div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="ocrPrevStep(2)">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                    <button type="button" id="ocrImportBtn" class="btn btn-success" onclick="importOcrData()">
                        <i class="fas fa-check"></i> Import Course
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Pass data to JavaScript
    window.OCCUPIED_SLOTS = {{ occupied_slots | tojson | safe }};
    window.DAY_LETTERS = {{ day_letters | tojson | safe }};
</script>
{% endblock %}