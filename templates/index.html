{% extends "base.html" %}

{% block title %}VIT Bhopal FFCS Timetable Maker{% endblock %}

{% block content %}
<!-- Header -->
<header class="app-header">
    <div class="header-container">
        <div class="header-logo">
            <h1><i class="fas fa-calendar-alt"></i> VIT Bhopal FFCS Timetable Maker</h1>
        </div>

        {% if not current_user %}
        <div class="guest-alert">
            <i class="fas fa-info-circle"></i>
            <span>Guest Mode: Data is temporary</span>
        </div>
        {% endif %}

        <div class="header-auth">
            {% if current_user %}
            <div class="user-profile">
                {% if current_user.profile_pic %}
                <img src="{{ current_user.profile_pic }}" alt="Avatar" class="user-avatar">
                {% endif %}
                <span class="user-name">{{ current_user.name }}</span>
                <a href="{{ url_for('auth.logout') }}" class="btn-logout" title="Logout">
                    <i class="fas fa-sign-out-alt"></i>
                </a>
            </div>
            {% else %}
            <a href="{{ url_for('auth.login') }}" class="btn-google-login">
                <svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="18px" height="18px" viewBox="0 0 48 48"
                    class="abcRioButtonSvg">
                    <g>
                        <path fill="#EA4335"
                            d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z">
                        </path>
                        <path fill="#4285F4"
                            d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z">
                        </path>
                        <path fill="#FBBC05"
                            d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z">
                        </path>
                        <path fill="#34A853"
                            d="M24 48c6.48 0 11.95-2.09 15.81-5.65l-7.73-6c-2.15 1.45-4.92 2.3-8.08 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z">
                        </path>
                        <path fill="none" d="M0 0h48v48H0z"></path>
                    </g>
                </svg> Login with VIT Email
            </a>
            {% endif %}
        </div>
    </div>


</header>

<!-- Main Content -->
<main class="app-main">
    <!-- Left Sidebar - Course Search -->
    <aside class="sidebar sidebar-left">
        <div class="search-panel">
            <h3><i class="fas fa-search"></i> Search Courses</h3>
            <div class="search-input-wrapper">
                <input type="text" id="courseSearch" placeholder="Enter Course Code (e.g., MAT2001)" autocomplete="off">
                <button type="button" id="searchBtn" class="btn btn-primary">
                    <i class="fas fa-search"></i> Find
                </button>
            </div>
            <div id="searchResults" class="search-results"></div>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
            <h3><i class="fas fa-bolt"></i> Quick Actions</h3>
            <ul class="action-list">
                <li>
                    <button onclick="viewRegisteredCourses()" class="action-btn">
                        <i class="fas fa-book"></i> View Registered Courses
                    </button>
                </li>
                <li>
                    <button onclick="viewAllCourses()" class="action-btn">
                        <i class="fas fa-list"></i> View All Courses
                    </button>
                </li>
                <li>
                    <button onclick="clearAllRegistrations()" class="action-btn action-danger">
                        <i class="fas fa-trash"></i> Clear All
                    </button>
                </li>
            </ul>
        </div>

        <!-- Auto Generate -->
        <div class="auto-generate-panel">
            <h3><i class="fas fa-magic"></i> Auto Generate</h3>
            <p class="upload-hint">Generate optimal clash-free timetable</p>
            <button type="button" class="btn btn-primary" onclick="openGenerateModal()">
                <i class="fas fa-wand-magic-sparkles"></i> Generate Timetable
            </button>
        </div>

        <!-- HTML Upload -->
        <div class="upload-panel">
            <h3>
                <i class="fas fa-upload"></i> Import Course Data
                <span class="info-icon" onclick="showImportHelp()" title="How to download HTML files">
                    <i class="fas fa-info-circle"></i>
                </span>
            </h3>
            <p class="upload-hint">Upload HTML files from VIT course registration pages</p>
            <div class="upload-area">
                <input type="file" id="htmlFileInput" accept=".html,.htm,.mhtml" multiple style="display: none;">
                <button type="button" id="uploadBtn" class="btn btn-secondary"
                    onclick="document.getElementById('htmlFileInput').click()">
                    <i class="fas fa-file-upload"></i> Select HTML Files
                </button>
                <span id="selectedFileName" class="file-name"></span>
            </div>
            <button type="button" id="importBtn" class="btn btn-success" onclick="importHtmlFiles()" disabled>
                <i class="fas fa-download"></i> Import All
            </button>
            <div id="uploadStatus" class="upload-status"></div>
        </div>

        <!-- Manual Entry -->
        <div class="manual-entry-panel">
            <h3><i class="fas fa-plus-circle"></i> Manual Entry</h3>
            <p class="upload-hint">Add course/slot without HTML file</p>
            <button type="button" class="btn btn-primary" onclick="openManualEntryModal()">
                <i class="fas fa-edit"></i> Add Course Manually
            </button>
        </div>
    </aside>

    <!-- Center - Timetable Grid -->
    <section class="timetable-section">
        <div class="timetable-header">
            <h2>Your Timetable</h2>
            <button class="btn btn-primary print-btn" onclick="downloadTimetablePDF()" title="Download as PDF">
                <i class="fas fa-file-pdf"></i> Download PDF
            </button>
            <div id="cellSelectionBar" class="cell-selection-bar" style="display: none;">
                <span id="selectedCellsCount">0 slots selected</span>
                <button type="button" class="btn btn-sm btn-secondary" onclick="clearCellSelection()">
                    <i class="fas fa-times"></i> Clear
                </button>
                <button type="button" class="btn btn-sm btn-success" onclick="openManualEntryModal()">
                    <i class="fas fa-plus"></i> Add Course
                </button>
            </div>
        </div>

        {% include "components/timetable_grid.html" %}

        <!-- Registered Courses List (moved below timetable) -->
        <div class="registered-panel-inline">
            <h3><i class="fas fa-list-check"></i> Registered Courses</h3>
            <div id="registeredCoursesList" class="registered-list-inline">
                {% if course_count == 0 %}
                <p class="empty-message">No courses registered yet.</p>
                {% endif %}
            </div>
        </div>
    </section>
</main>

<!-- Faculty Selection Modal -->
{% include "components/faculty_modal.html" %}

<!-- Auto-Generate Timetable Modal -->
{% include "components/generate_modal.html" %}

<!-- Registered Courses Modal -->
<div id="registeredModal" class="modal">
    <div class="modal-content modal-lg">
        <div class="modal-header">
            <h2><i class="fas fa-book"></i> Registered Courses</h2>
            <button class="modal-close" onclick="closeRegisteredModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div id="registeredModalContent"></div>
        </div>
    </div>
</div>

<!-- All Courses Modal -->
<div id="allCoursesModal" class="modal">
    <div class="modal-content modal-xl">
        <div class="modal-header">
            <h2><i class="fas fa-list"></i> All Courses</h2>
            <button class="modal-close" onclick="closeAllCoursesModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div id="allCoursesModalContent"></div>
        </div>
    </div>
</div>

<!-- Import Help Modal -->
<div id="importHelpModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-info-circle"></i> How to Download HTML Files</h2>
            <button class="modal-close" onclick="closeImportHelp()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="help-steps">
                <div class="help-step">
                    <span class="step-number">1</span>
                    <div class="step-content">
                        <strong>Login to VIT VTOP</strong>
                        <p>Log in to VIT mock registration portal</p>
                    </div>
                </div>
                <div class="help-step">
                    <span class="step-number">2</span>
                    <div class="step-content">
                        <strong>Select Course Category</strong>
                        <p>Select the course category you want to register for</p>
                    </div>
                </div>
                <div class="help-step">
                    <span class="step-number">3</span>
                    <div class="step-content">
                        <strong>Select Course</strong>
                        <p>Select the course you want to register for</p>
                    </div>
                </div>
                <div class="help-step">
                    <span class="step-number">4</span>
                    <div class="step-content">
                        <strong>Open faculty list</strong>
                        <p>open faculty list to view its slot options</p>
                    </div>
                </div>
                <div class="help-step">
                    <span class="step-number">5</span>
                    <div class="step-content">
                        <strong>Save Page as HTML</strong>
                        <p>Press <kbd>Ctrl</kbd>+<kbd>S</kbd> and save as "Webpage, HTML Only"</p>
                    </div>
                </div>
                <div class="help-step">
                    <span class="step-number">6</span>
                    <div class="step-content">
                        <strong>Upload Here</strong>
                        <p>Select the saved HTML file(s) and click Import</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Manual Entry Modal -->
<div id="manualEntryModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-plus-circle"></i> Add Course Manually</h2>
            <button class="modal-close" onclick="closeManualEntryModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="manualEntryForm" onsubmit="submitManualEntry(event)">
                <div class="form-group">
                    <label for="manualCourseCode">Course Code *</label>
                    <input type="text" id="manualCourseCode" required placeholder="e.g., CSE3006" class="form-control">
                </div>
                <div class="form-group">
                    <label for="manualCourseName">Course Name *</label>
                    <input type="text" id="manualCourseName" required placeholder="e.g., Computer Networks"
                        class="form-control">
                </div>
                <div class="form-group">
                    <label for="manualCredits">Credits</label>
                    <input type="number" id="manualCredits" min="0" max="20" placeholder="e.g., 4 (optional)"
                        class="form-control">
                </div>
                <div class="form-group">
                    <label for="manualSlotCode">Slot Code *</label>
                    <input type="text" id="manualSlotCode" required placeholder="e.g., A11+A12+A13"
                        class="form-control">
                </div>
                <div class="form-group">
                    <label for="manualVenue">Venue</label>
                    <input type="text" id="manualVenue" placeholder="e.g., AB505 (optional)" class="form-control">
                </div>
                <div class="form-group">
                    <label for="manualFaculty">Faculty Name</label>
                    <input type="text" id="manualFaculty" placeholder="e.g., John Doe (optional)" class="form-control">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeManualEntryModal()">Cancel</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-check"></i> Add Course
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Pass data to JavaScript
    window.OCCUPIED_SLOTS = {{ occupied_slots | tojson | safe }};
    window.DAY_LETTERS = {{ day_letters | tojson | safe }};
</script>
{% endblock %}